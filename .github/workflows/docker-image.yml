name: Docker Image CI

on: push

env:
    IMAGE_NAME: millicord
jobs:

  build:

    runs-on: ubuntu-latest


    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.REGISTRY_URL }}
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Extract branch name
      shell: bash
      run: echo "::set-output name=branch::${GITHUB_REF#refs/heads/}"
      id: extract_branch

    - name: build for master or develop
      env:
        DOCKER_BUILDKIT: 1
        REGISTRY: ${{ secrets.REGISTRY_URL }}
        BRANCH_NAME: ${{ steps.extract_branch.outputs.branch }}
        BUILD_NUMBER: ${{ github.run_number }}
      if: ${{ steps.extract_branch.outputs.branch == 'master' || steps.extract_branch.outputs.branch == 'develop' }}
      run: |
        docker build \
          --cache-from=${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-latest --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-${BUILD_NUMBER} -t ${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-latest .
        docker push ${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-${BUILD_NUMBER}
        docker push ${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-latest

    - name: build for master or develop
      env:
        DOCKER_BUILDKIT: 1
        REGISTRY: ${{ secrets.REGISTRY_URL }}
        BRANCH_NAME: ${{ steps.extract_branch.outputs.branch }}
        BUILD_NUMBER: ${{ github.run_number }}
      if: ${{ steps.extract_branch.outputs.branch != 'master' && steps.extract_branch.outputs.branch != 'develop' }}
      run: |
        docker build \
          --cache-from=${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-latest --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t ${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-latest .
        docker push ${REGISTRY}/${IMAGE_NAME}:${BRANCH_NAME}-latest

